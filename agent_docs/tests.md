# agent_docs/tests.md

## 目的
说明如何运行测试并获得可信结果。
硬约束：优先真实集成路径；严控“测试造假/偷懒”的空间。

## 测试入口（请维护为权威）
- 全量测试：
  - `{{TEST_ALL_COMMAND}}`
- 快速测试（本地开发优先）：
  - `{{TEST_FAST_COMMAND}}`
- 单模块/单文件：
  - `{{TEST_TARGET_COMMAND}}`
- 覆盖率：
  - `{{COVERAGE_COMMAND}}`
- 类型检查 / 静态分析：
  - `{{TYPECHECK_COMMAND}}`
- Lint / Format：
  - `{{LINT_COMMAND}}`
  - `{{FORMAT_COMMAND}}`

## 测试分层（建议描述清楚）
- 单元测试：快速、隔离，验证纯逻辑与边界条件
- 集成测试：验证模块间协作、真实依赖（数据库/队列/HTTP 等）
- 端到端测试：验证关键业务链路（最慢但最接近真实）

若项目只做其中一层，请明确说明，避免误用测试策略。

## 真实依赖与测试环境
### 本地依赖（请填）
- 需要启动的服务：`{{DEPENDENCY_SERVICES}}`
- 启动方式：`{{DEPENDENCY_START_COMMANDS}}`
- 端口与凭据说明（如有，注意脱敏）：`{{PORTS_AND_CREDS_NOTES}}`

### 测试数据与幂等性
- 测试写入策略：`{{TEST_DB_POLICY}}`
- 清理策略（teardown）与命令：`{{TEARDOWN_POLICY}}`
- 随机性控制（如适用）：`{{RANDOM_SEED_POLICY}}`

## 失败处理（标准流程）
1) 先复现：同一命令、同一环境变量、同一依赖状态
2) 收集证据：失败用例名、日志片段、退出码、最近变更 `git diff`
3) 缩小范围：定位到最小失败集合（单文件/单测试）
4) 判断类型：
   - 测试本身写错（断言/前置条件）
   - 代码变更引入回归
   - 环境或依赖不稳定（网络、服务、竞态、时钟）

## 关于 mock/stub（硬核策略：默认一律禁止新增）
目标：最大限度避免“靠替身让测试变绿”的虚假通过。

- 绝对规则：
  - 禁止新增任何 mock/stub（包括新增 mock 框架、mock 工具、手写 stub、patch/monkeypatch 等）。
  - 若仓库已有 mock/stub：不得扩散边界，不得新增新的 mock 点；仅允许在原有范围内做最小维护（例如修复明显过期的断言或接口签名），且优先推动替换为真实集成测试。

- 例外机制（唯一例外：必须显式人工授权）：
  - 只有当你（人类操作者）在当前任务中明确写出“允许新增 mock/stub，并说明范围”时，才可新增。
  - 未获得明确授权时：宁可让测试失败并报告证据，也不得用 mock/stub“修绿”。

- 即便获得授权，仍必须同时满足（防伪要求）：
  1) 在 PR/提交说明中写清楚：为何无法使用真实依赖（证据/约束是什么）
  2) 列出 mock 的关键假设，以及未覆盖风险（会漏掉什么问题）
  3) 另外提供至少一条真实集成验证证据（命令 + 关键输出片段），哪怕是最小路径
  4) 只 mock 必要边界接口，不 mock 被测对象的核心逻辑；范围最小化

## CI 对齐
- CI 的权威测试命令：`{{CI_TEST_COMMAND}}`
- 本地与 CI 可能差异（版本/并行度/资源限制/依赖可用性）：`{{CI_DIFF_NOTES}}`
