# agent_docs/debugging.md

## 目的
提供一套可复用的排障流程：先用工具建立事实，再做最小修复。
不假设具体发行版；以“当前环境可用的 CLI 工具”为准。

## 标准排障流程（固定顺序）
1) 复现：同命令、同环境变量、同依赖状态
2) 收集证据：
   - 错误全文（关键堆栈/退出码）
   - 相关日志片段（不要贴全量）
   - 最近变更：`git diff` / `git status`
3) 缩小范围：
   - 最小失败用例/最小输入
   - 二分定位（按提交或按代码块）
4) 分类处理：
   - 代码问题 / 测试问题 / 环境问题 / 依赖问题 / 资源问题
5) 修复后验证：
   - 跑最小相关校验，再跑关键回归链路

## 常见故障类型与处理要点
### 构建失败
- 先确认入口命令与版本是否匹配（见 build.md）
- 记录：工具版本、运行时版本、失败阶段（安装/编译/链接/打包）

### 测试不稳定（flaky）
- 优先怀疑：
  - 竞态（并发、时序）
  - 外部依赖不稳定（网络、服务）
  - 未清理的状态（数据库/缓存/临时文件）
- 做法：
  - 固定随机种子（如适用）
  - 降低并行度或隔离资源
  - 把依赖显式化（启动/端口/清理）

### 运行时错误定位
- 先拿到：
  - 发生时间范围
  - 请求/任务标识（request_id、trace_id 等，如有）
  - 关键输入与用户场景（脱敏）
- 再做关联：
  - 日志 -> 指标 -> 追踪（以项目权威可观测体系为准）

## 资源压力（OOM / I/O / CPU）
当出现“卡死、长时间无响应、构建/测试异常慢”时，优先排查资源：

### 观察（按环境可用工具选择）
- 内存：选择可用工具查看内存/交换区/压力指标
- 进程：`top` / `ps`（或已安装的更友好替代工具）
- 磁盘：`df -h`、`du`、以及可用的 I/O 观测工具（如有）
- 系统日志：用环境可用的日志查看工具定位 OOM/异常（如有）

### 降低失败半径（可选策略）
- 对“重步骤”（例如报告生成、打包、长链路测试）：
  - 降低并行度
  - 分阶段执行
  - 必要时给进程加资源上限（仅在你确认环境支持且不会影响其他任务时）

## 输出规范（排障时必须包含）
- 复现命令（完整）
- 关键错误/日志片段（足够定位，不贴全量）
- 环境摘要（运行时版本、关键工具版本）
- 最近改动摘要（相关 diff 或提交）
- 下一步建议（1~2 个，最小化）
